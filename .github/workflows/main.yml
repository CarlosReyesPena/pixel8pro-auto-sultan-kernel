name: Build Kernel

on:
  workflow_dispatch:
    inputs:
      kernel_name:
        description: 'Auto build of sultAn kernel'
        required: true
        default: 'autoSult'

jobs:
  build-kernel:
    name: Build Kernel
    runs-on: ubuntu-20.04
    env:
      KERNEL_NAME: ${{ github.event.inputs.kernel_name }}

    steps:
      - name: Checkout kernel source
        uses: actions/checkout@v3
        with:
          repository: sultanxda/android_kernel_google_zuma
          ref: 15.0.0-sultan
          path: kernel

      - name: Modify kernel version in defconfig
        run: |
          sed -i 's/CONFIG_LOCALVERSION=".*"/CONFIG_LOCALVERSION="-${{ env.KERNEL_NAME }}"/' kernel/arch/arm64/configs/zuma_defconfig

      - name: Modify Makefile EXTRAVERSION
        run: |
          sed -i 's/^EXTRAVERSION =.*/EXTRAVERSION = -${{ env.KERNEL_NAME }}/' kernel/Makefile

      - name: Build Kernel
        uses: dabao1955/kernel_build_action@main
        with:
          kernel-dir: kernel
          config: zuma_defconfig
          arch: arm64
          aosp-gcc: true
          aosp-clang: true
          android-version: 15
          aosp-clang-version: r487747
          anykernel3: true
          release: true
          access-token: ${{ secrets.GITHUB_TOKEN }}
